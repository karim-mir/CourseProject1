# Course project №1
Проект реализует информацию о курсе валют, акций через API, общую сумму расходов, а также предоставляет информацию о последних транзакциях по сумме платежа

## Конфигурация API

Для работы с проектом необходимо настроить доступ к API. Вам понадобятся следующие ключи и параметры из файла `.env`:
`EXCHANGE_API_KEY` - API ключ для цен на акции и данных о валютах
`STOCK_API_KEY` - API ключ данных о ценах на акции
`CURRENCY_API_KEY` - API ключ данных о валютах
`STOCK_API_URL=https://www.alphavantage.co/` - Параметры для API цен на акции
`CURRENCY_API_URL=https://api.apilayer.com/exchangerates_data` - URL API данных о валютах

## Функции модуля `views.py`
Модуль `views.py` отвечает за загрузку данных о транзакциях, их обработку и формирование JSON-ответа для дальнейшего использования в приложении. Он включает в себя несколько ключевых функций:
### Основные функции

1. **`load_operations_data(file_path)`**:
   - Загружает данные из файла Excel (`operations.xlsx`), содержащего информацию о транзакциях.
   - Преобразует даты и суммы операций в нужные форматы.
   - Проверяет наличие необходимых столбцов в загружаемых данных.
   - Возвращает данные в формате списка словарей или логирует ошибку в случае неудачи.

2. **`generate_report(file_path, user_currencies, user_stocks)`**:
   - Использует функцию `load_operations_data()` для загрузки операций.
   - Генерирует отчёт, содержащий информацию о тратах по картам, топ-5 транзакциях, курсы валют и цены акций, используя внешние функции из модуля `src.utils`.
   - Возвращает JSON-ответ с отчетом, который может быть использован на фронтенде приложения.

3. **`create_json_response(greeting, cards, top_transactions, currency_rates, stock_prices)`**:
   - Формирует JSON-ответ, который включает приветствие, информацию о картах, топ-транзакциях, курсах валют и ценах акций.

### Использование

Модуль `views.py` может быть использован для обработки данных о транзакциях и генерации отчетов. Чтобы использовать его, следует импортировать необходимые функции и передать путь к файлу с данными, а также списки пользовательских валют и акций.

Пример использования:
```commandline
import os
from src.views import generate_report

user_currencies = ["USD", "EUR"]  # Пример списка валют
user_stocks = ["AAPL", "AMZN"]  # Пример списка акций
json_response = generate_report(
    os.path.abspath(os.path.join("..", "data", "operations.xlsx")),
    user_currencies,
    user_stocks)

print(json_response)
```

### Логгирование
Модуль включает настройку логгирования для отслеживания ошибок:
- Логи ошибок при загрузке данных будут записываться с использованием уровня `ERROR`.
- Информация о успешной загрузке данных также будет записываться с использованием уровня `INFO`.

### Зависимости
Не забудьте установить необходимые библиотеки:
```pip install pandas```

## Функции модуля `utils.py`

Модуль utils.py содержит вспомогательные функции для обработки данных и интеграции с внешними API для получения актуальной информации о валютах и акциях.

### Основные функции

1. load_user_settings(file_path):
   - Загружает настройки пользователя из JSON файла.

2. get_greeting():
   - Возвращает приветствие в зависимости от времени суток.

3. get_currency_rates(user_currencies):
   - Получает актуальные курсы валют для списка заданных валют с использованием API.
   - Логирует запросы к API и ответные данные для отладки.

4. get_stock_prices(user_stocks):
   - Получает текущие цены акций для заданных акций с использованием API.
   - Логирует запросы к API и ответные данные для отладки.

5. calculate_cashback(total_spent):
   - Вычисляет кэшбэк от общей суммы расходов. В данной реализации кэшбэк составляет 1% от суммы.

### Зависимости
Модуль требует установки следующих библиотек:
 - requests: для отправки HTTP-запросов к API.
 - dotenv: для загрузки переменных окружения из файла .env.

### Пример использования
Пример функции для получения курсов валют и цен акций:
```import os
from src.utils import get_currency_rates, get_stock_prices

user_currencies = ["USD", "EUR"]  # Пример списка валют
user_stocks = ["AAPL", "AMZN"]  # Пример списка акций

currency_rates = get_currency_rates(user_currencies)
stock_prices = get_stock_prices(user_stocks)

print("Курсы валют:", currency_rates)
print("Цены акций:", stock_prices)
```

## Описание модуля `reports.py`

Модуль `reports.py` предназначен для создания отчетов о тратах в различных категориях и сохранения этих отчетов в формате JSON.;

### Основные функции

1. save_report(file_name: str = "my_json.json"):
   - Декоратор, который сохраняет результаты функций в указанный JSON-файл.
   - Преобразует столбец с датами для корректной сериализации в JSON.
   
2. spending_by_category(transactions: pd.DataFrame, category: str, date: Optional[str] = None) -> pd.DataFrame:
   - Принимает DataFrame с транзакциями и фильтрует данные по указанной категории и дате.
   - Возвращает DataFrame с отфильтрованными результатами, включая дату платежа, сумму операции и описание.

### Пример использования

Чтобы получить отчет о тратах в определенной категории, можно использовать следующий код:
```
import pandas as pd
from src.reports import spending_by_category

# Загрузка транзакций из файла Excel
transactions_df = pd.read_excel("../data/operations.xlsx")
result = spending_by_category(transactions_df, category="Супермаркеты")
print("Отчет по тратам для категории 'Супермаркеты':")
print(result)
```

### Логгирование
Модуль включает настройку логгирования для отслеживания сохранения отчетов и ошибок при обработке данных.

## Зависимости
Не забудьте установить необходимые библиотеки:
```pip install pandas```

## Описание модуля `reports.py`

Модуль `reports.py` содержит функции для генерации отчетов о расходах на основе данных о транзакциях. Основная функция оформлена с помощью декоратора, который позволяет сохранять полученные данные в JSON-файл.

### Основные функции

1. save_report(file_name: str = "my_json.json"):
   - Декоратор, обеспечивающий сохранение результатов выполнения функций в JSON-файл.

2. spending_by_category(transactions: pd.DataFrame, category: str, date: Optional[str] = None) -> pd.DataFrame:
   - Генерирует отчет о расходах по указанной категории за последние три месяца, заканчиваясь на указанной дате (или на дате самой поздней транзакции, если дата не указана).

### Пример использования
Чтобы получить отчет по тратам для конкретной категории, можно использовать следующий код:
```import pandas as pd
from src.reports import spending_by_category

# Пример создания DataFrame из файла Excel
transactions_df = pd.read_excel("../data/operations.xlsx")
# Вызываем функцию для получения отчета
result = spending_by_category(transactions_df, category="Супермаркеты")
# Печать результата
print("Отчет по тратам для категории 'Супермаркеты':")
print(result)
```
## Описание модуля main.py

Модуль `main.py` является точкой входа в приложение и отвечает за обработку операций, загрузку пользовательских настроек и генерацию отчетов.

### Основные функции

1. process_operations(operations):
   - Обрабатывает загруженные операции для вычисления общих затрат и кэшбэка по картам.

2. main():
   - Основная функция, выполняющая загрузку данных, аналитические расчеты и формирование JSON-ответа.

### Пример использования
Модуль может быть запущен напрямую, и он запрашивает у пользователя дату для анализа и обработки данных:

```python main.py```

После запуска, приложение выводит JSON-ответ с анализом расходов и кэшбэка.
## Зависимости

Не забудьте установить необходимые библиотеки:
```pip install pandas requests python-dotenv```

## Тестирование

Для обеспечения правильности работы приложения, используются тесты на базе библиотеки `pytest`. Тесты помогают проверять корректность выполнения функций и взаимодействие между модулями.

### Установка

Для запуска тестов требуется установить `pytest` и `unittest.mock`:

``` pip install pytest pandas openpyxl requests python-dotenv```

### Запуск тестов

Чтобы запустить все тесты, выполните следующую команду в терминале:

```pytest```

### Использование фикстур

Фикстуры в `pytest` позволяют использовать повторяющиеся настройки для тестов. Вот пример фикстуры:

```import pytest
from src.models import MyModel
@pytest.fixture
def sample_model():
    return MyModel(data={'key': 'value'})
   ```

### Использование Mock и Patch

Библиотека `unittest.mock` предоставляет возможность замещения объектов во время выполнения. Вот пример использования `mock` и `patch`:
```
from unittest.mock import patch, Mock
from src.services import MyService
def test_my_service():
    with patch('src.services.external_api') as mock_api:
    mock_api.return_value = Mock(status_code=200, json=lambda: {"key": "value"})
    service = MyService()
    result = service.get_data()&#13
    assert result['key'] == 'value'
```

### Структура тестов

Тесты организованы в директории `tests`. Каждый файл начинается с префикса `test_`, чтобы `pytest` мог их обнаружить.

### Покрытие тестами

Для проверки покрытия тестами используйте `pytest-cov`. Установите библиотеку:

```pip install pytest-cov```

И выполните тесты с дополнительной опцией:
```pytest --cov=src```
