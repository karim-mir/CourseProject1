# Course project №1

Приложение для анализа банковских операций.

## `views.py`

Модуль `views.py` содержит бизнес-логику для работы с пользовательскими транзакциями и данными о валютных курсах и акциях. Он включает в себя следующие функции:
- Загрузка настроек: Загружает настройки пользователя из файла `user_settings.json`. Путь к файлу определяется относительно текущего скрипта. Если файл не найден, вызывается `FileNotFoundError`.

- Фильтрация транзакций: 
  - Функция `filter_transactions(start_date, end_date)` позволяет фильтровать транзакции в заданном диапазоне дат. Транзакции представлены в формате списка словарей, содержащих дату, сумму и категорию расхода.
  
- Расчет расходов:
  - Функция `calculate_expenses(transactions)` вычисляет общую сумму расходов и сумму расходов по категориям. Она возвращает структуру данных, содержащую общую сумму расходов и список основных категорий расходов.

- Получение данных о валютных курсах:
  - Функция `get_currency_data()` извлекает данные о валютных курсах из удаленного API. Она используется для получения текущих курсов валют, которые указаны в настройках пользователя. Запрос выполняется с использованием API-ключа и URL, которые считываются из переменных окружения.

- Получение данных о ценах на акции: 
  - Функция `get_stock_data(symbol)` извлекает последние данные о ценах на акции из API по заданному символу. Она проверяет наличие переменных окружения для API и обрабатывает ошибки, связанные с запросами. Если данные не найдены, выбрасывает исключение.

- Генерация отчетов: 
  - Функция `generate_report(date_str, stock_symbol)` генерирует отчет на основе данных о расходах, курсах валют и ценах на акции для заданной даты и символа акции.
  
### Пример использования

Для фильтрации транзакций за определенный период и получения расходов по категориям, можно использовать функции следующим образом:
```commandline
from datetime import datetime
from views import filter_transactions, calculate_expenses

start_date = datetime.strptime("2020-05-01", "%Y-%m-%d")
end_date = datetime.strptime("2020-05-10", "%Y-%m-%d")
filtered_transactions = filter_transactions(start_date, end_date)
expenses = calculate_expenses(filtered_transactions)
```
Для получения отчета за определенный месяц с ценами акций можно использовать следующие функции:
```commandline
from views import generate_report

date_str = "2020-05-01"
stock_symbol = "AAPL"
report = generate_report(date_str, stock_symbol)

print(report)
```

### `test_views.py`

Модуль `test_views.py` содержит тесты для функций, определённых в модуле `views.py`. Тесты использует пакет `unittest` для проверки корректности работы бизнес-логики.

#### Тестовые функции
Вот основные тесты, реализованные в данном модуле:

- `test_get_currency_data`: Проверяет, что функция `get_currency_data` возвращает правильные данные, полученные от API валют. Используется `unittest.mock` для имитации ответа API.

- `test_filter_transactions`: Проверяет, что функция `filter_transactions` корректно фильтрует транзакции по заданному диапазону дат.

- `test_calculate_expenses`: Проверяет работу функции `calculate_expenses` и правильность расчета общей суммы расходов и категорий.

- `test_get_stock_data`: Проверяет, что функция `get_stock_data` возвращает правильные данные о ценах на акции при корректных условиях.

- `test_get_stock_data_invalid_json`: Проверяет, что функция `get_stock_data` выбрасывает исключение `ValueError`, когда API возвращает некорректный JSON.

- `test_generate_report`: Проверяет, что функция `generate_report` правильно генерирует отчет, используя заглушки для вызовов к другим функциям.

В данном примере предполагается, что вы используете структуру каталогов (например, папка `tests`) для хранения всех тестов.

## Замечания
Обратите внимание, что при выполнении тестов вы должны иметь корректные настройки для переменных окружения, используемых в функциях вашего приложения.

### `app.py`

Модуль `app.py` содержит основной код приложения Flask, предоставляя API для получения данных о валютах, акциях и информации по картам и транзакциям.

#### Настройки приложения
- Используется библиотека `dotenv` для загрузки переменных окружения из файла `.env`.
- Настроено логирование для отслеживания ошибок и отладочных сообщений.

#### Маршруты API
- `GET /`: Корневой маршрут, возвращает приветственное сообщение.
- `GET /currency`: Возвращает данные о текущих курсах валют.
  При возникновении ошибок, возвращает сообщение об ошибке с кодом 500.
- `GET /stock/<symbol>`: Возвращает данные о ценах на акции для заданного символа.
  При ошибках возвращает код 404 для несуществующих акций или код 500 для остальных ошибок.

#### Пример маршрута для получения данных
- `GET /api/data`: Принимает параметр `date_time` формата `YYYY-MM-DD HH:MM:SS` и возвращает приветствие в зависимости от времени суток, а также информацию по картам, топ-транзакциям, курсам валют и ценам акций.
Если параметр отсутствует или неверный, возвращает соответствующее сообщение об ошибке с кодом 400.

#### Функции
Ниже приведены две основные функции, определенные в этом модуле:

- `get_greeting(current_time)`: Возвращает приветствие в зависимости от текущего времени.
- `calculate_cashback(expenses)`: Рассчитывает кэшбэк на основе расходов.

### `test_app.py`

Модуль `test_app.py` содержит тесты для маршрутов API, определённых в `app.py`. Тесты выполняются с использованием пакета `unittest` и позволяют убедиться в корректности работы методов обработки запросов.

#### Тестовые функции
Основные тестовые функции в данном модуле:

- `test_home`: Проверяет корневой маршрут (`GET /`), возвращая статус 200 и сообщение "Welcome to the Financial API!".

- `test_currency`: Проверяет маршрут для получения данных о валютах (`GET /currency`). Использует заглушку (`mock`) для имитации ответа от функции `get_currency_data`.

- `test_get_stock`: Проверяет маршрут для получения данных об акциях (`GET /stock/<symbol>`). Возвращает статус 404, когда акция не найдена.

- `test_get_stock_not_found`: Имитация ошибки получения данных об акции по неправильному символу. Возвращает статус 404 и сообщение об ошибке.

- `test_get_data_success`: Проверяет успешное получение данных по маршруту (`GET /api/data`). Подразумевает передачу корректного параметра `date_time` и возвращает статус 200 с данными о приветствии, картах, топовых транзакциях, курсах валют и ценах на акции.

- `test_get_data_missing_date_time`: Проверяет ошибку, когда параметр `date_time` отсутствует. Возвращает статус 400 с соответствующим сообщением.

- `test_get_data_invalid_date_format`: Проверяет, что неверный формат даты приводит к ошибке. Возвращает статус 400 с сообщением об ошибке.

#### Запуск тестов
Тесты можно запускать с помощью команды в терминале, находясь в корневой директории проекта. Пример команды:

```pytest tests/test_views.py```

### Файл конфигурации `.env`

Файл `.env` содержит переменные окружения, которые используются для настройки приложения. Ниже приведены основные параметры и их назначения:

### Настройка окружения

1. Скопируйте файл `.env.sample` в файл `.env`:
```commandline
cp.env.sample.env
```
2. Заполните переменные в файле `.env` своими актуальными значениями.
3. Убедитесь, что файл `.env` добавлен в ваше `.gitignore`, чтобы не коммитить конфиденциальные данные.

#### API ключи
 `EXCHANGE_API_KEY`: Ключ для API обменных курсов.
 `STOCK_API_KEY`: Ключ для API получения данных о ценах на акции.
 `CURRENCY_API_KEY`: Ключ для API получения данных о валютах.

#### URL API
 `STOCK_API_URL`: URL для API данных о ценах на акции (например, Alpha Vantage).
 `CURRENCY_API_URL`: URL для API данных о валютах (например, Apilayer).

#### Настройки базы данных
 `DATABASE_URL`: URL вашей базы данных. В примере используется SQLite. Замените его на ваши настройки, если используете другую БД.

#### Настройки логирования
 `LOG_LEVEL`: Уровень логирования для приложения. Возможные значения: `DEBUG`, `INFO`, `WARNING`, `ERROR`.

#### Прочие параметры
 `DEBUG_MODE`: Флаг для включения режима отладки. Установите значение `True` или `False` в зависимости от того, нужен ли вам режим отладки.

Обязательно создайте файл `.env` в корневой директории проекта и добавьте в него необходимые переменные перед запуском приложения.